---
id: DS-019
title: Webview Foundation + Theme
type: feature
epic: EPIC-005
status: done
sprint: phase-5
size: M
assignee: ""
dependencies:
  - [[DS-004]]
created: 2025-11-26
updated: 2025-11-28
---

# Webview Foundation + Theme

## Description
Set up the webview infrastructure for the Kanban board with proper VS Code theme integration and bidirectional communication.

## Acceptance Criteria

### MVP
- [x] `WebviewViewProvider` registered for board view
- [x] Webview loads HTML content from bundled files
- [x] Extension sends initial data (stories, statuses) to webview via postMessage
- [x] Webview can send messages back to extension
- [x] Basic error handling for communication failures

### Enhanced
- [x] **VS Code theme integration**: Board uses VS Code's CSS variables for colors
- [x] **Dark/light mode**: Automatically matches VS Code theme
- [x] **Webview state persistence**: Restore scroll position, collapsed columns on reload
- [x] **Loading state**: Show skeleton/spinner while data loads
- [ ] **Connection status**: Indicator if webview loses sync with extension (DEFERRED)

## Technical Notes
- WebviewViewProvider vs WebviewPanel: Use ViewProvider for sidebar integration
- CSP (Content Security Policy): Must allow scripts, styles from webview
- Theme CSS vars: `--vscode-editor-background`, `--vscode-foreground`, etc.
- State persistence: Use `webview.setState()` and `getState()`

## Message Protocol

### Extension → Webview
```typescript
// Initial load
{ type: 'init', payload: { stories: Story[], statuses: Status[] } }

// Story updated (from file change)
{ type: 'storyUpdated', payload: { story: Story } }

// Story deleted
{ type: 'storyDeleted', payload: { id: string } }
```

### Webview → Extension
```typescript
// Status change from drag-drop
{ type: 'updateStatus', payload: { storyId: string, newStatus: string } }

// Request to open story file
{ type: 'openStory', payload: { id: string } }

// Filter changed
{ type: 'filterChanged', payload: { sprint: string | null, epic: string | null } }
```

## Webview HTML Structure

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="...">
  <link href="${styleUri}" rel="stylesheet">
</head>
<body>
  <div id="board-root">
    <div class="board-header"><!-- filters --></div>
    <div class="board-columns"><!-- kanban columns --></div>
  </div>
  <script src="${scriptUri}"></script>
</body>
</html>
```

## Theme Variables (VS Code)

```css
:root {
  --card-bg: var(--vscode-editor-background);
  --card-border: var(--vscode-panel-border);
  --card-text: var(--vscode-foreground);
  --column-bg: var(--vscode-sideBar-background);
  --accent: var(--vscode-focusBorder);
}
```

## Implementation Notes

### Files Created
- `src/types/webviewMessages.ts` - Type-safe message protocol (ExtensionMessage, WebviewMessage unions)
- `src/view/boardViewUtils.ts` - Pure utility functions (parseStatuses, serialize*, generateNonce)
- `src/view/boardView.ts` - BoardViewProvider implementation
- `webview/board.css` - VS Code themed styles with CSS variables
- `webview/board.js` - Webview-side JS with state management and `window.boardApi`
- `src/test/unit/boardView.test.ts` - 25 unit tests
- `src/test/suite/boardView.test.ts` - 8 integration tests

### Build Pipeline
- `esbuild.js` updated with `copyWebviewAssets()` function
- Copies `webview/*.{css,js}` to `dist/webview/` on build
- Watches webview directory in watch mode

### Security
- WebviewStory/WebviewEpic exclude `filePath` and `content` fields
- CSP restricts scripts to nonce-based, styles to webview source
- No direct file access from webview

### Future Hooks (for DS-020+)
- `window.boardApi.updateStatus(storyId, newStatus)` - DS-021/DS-022
- `window.boardApi.openStory(id)` - Already functional
- `window.boardApi.setFilter(sprint, epic)` - DS-023
- `handleMessage()` logs updateStatus/filterChanged for future implementation

## Deferred Decisions

### Connection Status Indicator
**Decision**: Deferred to future story if needed
**Rationale**: Store synchronization via file watcher is already reliable. Adding heartbeat checking and reconnection UI adds complexity for minimal benefit. Can revisit if users report sync issues in practice.
