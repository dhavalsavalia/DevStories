---
id: DS-021
title: Drag-Drop + Keyboard Navigation
type: feature
epic: EPIC-005
status: done
sprint: phase-5
size: M
assignee: ""
dependencies:
  - [[DS-020]]
created: 2025-11-26
updated: 2025-11-28
---

# Drag-Drop + Keyboard Navigation

## Description
Smooth drag-and-drop for moving stories between columns, plus full keyboard navigation for accessibility and power users.

## Acceptance Criteria

### MVP
- [x] Cards are draggable (HTML5 drag-drop API)
- [x] Visual feedback during drag (card ghost, drop zone highlight)
- [x] Dropping card in new column sends `updateStatus` message
- [x] Optimistic UI update (immediate visual move)
- [x] Revert position if backend update fails
- [x] Cards maintain order within column

### Enhanced
- [x] **Keyboard navigation**:
  - `j/k` or `↑/↓`: Move between cards
  - `h/l` or `←/→`: Move between columns
  - `Enter`: Open story file
  - `Space`: Quick status advance
  - `1-4`: Jump to column by number
- [ ] **Touch support**: Works on touch devices (tablet/convertible) - deferred
- [ ] **Multi-select drag**: Drag multiple cards at once (Cmd+Click to select) - deferred
- [ ] **Drag to reorder**: Within same column, reorder cards (requires order field) - deferred
- [x] **Animation**: Smooth transitions when cards move

## Technical Notes
- HTML5 Drag and Drop API: `draggable`, `ondragstart`, `ondrop`
- Keyboard: Global keydown listener with focus management
- Optimistic update: Update UI immediately, rollback on error
- Animation: CSS transitions on transform/opacity

## Drag-Drop Implementation

```javascript
// Card element
card.draggable = true;
card.addEventListener('dragstart', (e) => {
  e.dataTransfer.setData('text/plain', storyId);
  card.classList.add('dragging');
});

// Column drop zone
column.addEventListener('dragover', (e) => {
  e.preventDefault();
  column.classList.add('drag-over');
});

column.addEventListener('drop', (e) => {
  e.preventDefault();
  const storyId = e.dataTransfer.getData('text/plain');
  const newStatus = column.dataset.status;
  vscode.postMessage({ type: 'updateStatus', payload: { storyId, newStatus } });
});
```

## Keyboard Navigation

```
Board State:
┌─────┬─────────────┬────────┬──────┐
│ To  │ In Progress │ Review │ Done │
│ Do  │             │        │      │
├─────┼─────────────┼────────┼──────┤
│[*1] │ [4]         │        │ [6]  │  ← * = focused
│ [2] │ [5]         │        │      │
│ [3] │             │        │      │
└─────┴─────────────┴────────┴──────┘

Keys:
- j/↓: Focus card 2
- k/↑: Focus card 1 (wrap to bottom)
- l/→: Focus card 4 (first in next column)
- h/←: Focus card 6 (last column's first)
- Enter: Open card 1's file
- Space: Move card 1 to "In Progress"
- 3: Jump to Review column
```

## Visual Feedback

### During Drag
- Dragged card: `opacity: 0.5`, slight scale up
- Valid drop zone: Blue border highlight
- Invalid zone (same column): No highlight

### On Drop
- Success: Card slides into position (transform animation)
- Failure: Card returns to original position with shake animation

## Error Handling

```javascript
// Optimistic update with rollback
const originalColumn = card.parentElement;
const originalIndex = Array.from(originalColumn.children).indexOf(card);

// Move immediately
targetColumn.appendChild(card);

// Send to extension
vscode.postMessage({ type: 'updateStatus', ... });

// Listen for result
window.addEventListener('message', (e) => {
  if (e.data.type === 'updateFailed') {
    // Rollback
    originalColumn.insertBefore(card, originalColumn.children[originalIndex]);
    showError('Failed to update status');
  }
});
```

## Implementation Notes

### Files Changed
- `src/view/boardViewUtils.ts` - Added navigation utilities: `getNextColumnIndex`, `getPrevColumnIndex`, `getNextCardIndex`, `getPrevCardIndex`, `findFirstCardInColumn`, `getCardIndexInColumn`, `getColumnIndexByStatus`, `getStatusByColumnIndex`, `getNextStatusInWorkflow`
- `src/view/boardView.ts` - Added `updateStoryStatus()` method to handle webview status updates
- `src/types/webviewMessages.ts` - Added `updateFailed` message type for rollback
- `webview/board.css` - Added drag-drop styles (`.dragging`, `.drag-over`), keyboard focus (`.focused`), animations (`.just-moved`, `.update-failed`)
- `webview/board.js` - Full drag-drop + keyboard navigation implementation
- `src/test/unit/boardView.test.ts` - 25 new tests for navigation utilities
- `src/test/suite/boardView.test.ts` - 12 new integration tests

### Architecture Decisions
- **Optimistic UI**: Card moves immediately on drop, with rollback on `updateFailed` message
- **Focus state**: Stored in webview state, persisted across reloads
- **Keyboard navigation**: Uses vim-style keys (hjkl) alongside arrow keys
- **File updates**: Reuses `updateStoryStatus` from changeStatusUtils.ts for consistency

### Test Results
- Unit tests: 271 passing (+25 new)
- Integration tests: 105 passing (+12 new)

## Deferred Decisions
- **Touch support**: Webview touch events need investigation, low priority for desktop-focused extension
- **Multi-select drag**: Requires selection state management, would add complexity
- **Drag to reorder**: Requires `order` field in frontmatter, architectural change for future
