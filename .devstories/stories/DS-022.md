---
id: DS-022
title: File Writer + Conflict Handling
type: feature
epic: EPIC-005
status: todo
sprint: phase-5
size: M
assignee: ""
dependencies:
  - DS-021
  - DS-005
created: 2025-11-26
updated: 2025-11-28
---

# File Writer + Conflict Handling

## Description
Robust file writing that safely updates frontmatter while preserving markdown content, with conflict detection for concurrent edits.

## Acceptance Criteria

### MVP
- [ ] `Writer.updateField(filePath, field, value)` updates single frontmatter field
- [ ] `Writer.updateStatus(storyId, newStatus)` convenience method
- [ ] Uses gray-matter to parse and stringify frontmatter
- [ ] Markdown body is strictly preserved (byte-for-byte)
- [ ] Auto-updates `updated` timestamp on any write
- [ ] File watcher picks up changes and updates store

### Enhanced
- [ ] **Conflict detection**: Check file hasn't changed since last read before writing
- [ ] **Batch updates**: Update multiple fields in single write operation
- [ ] **Undo support**: Store previous state for potential rollback
- [ ] **Write queue**: Prevent race conditions with sequential write queue
- [ ] **Backup**: Optional backup of original file before modification

## Technical Notes
- gray-matter: Parse frontmatter, modify data object, stringify back
- Content preservation: gray-matter keeps `content` property separate
- Conflict detection: Store file mtime or content hash in Store
- Write queue: Simple async queue to serialize file writes

## Writer API

```typescript
class Writer {
  // Update single field
  async updateField(storyId: string, field: string, value: any): Promise<void>;

  // Update multiple fields
  async updateFields(storyId: string, updates: Record<string, any>): Promise<void>;

  // Convenience methods
  async updateStatus(storyId: string, status: string): Promise<void>;
  async updateAssignee(storyId: string, assignee: string): Promise<void>;

  // Full story update (from board or form)
  async updateStory(storyId: string, partial: Partial<StoryFrontmatter>): Promise<void>;
}
```

## Implementation

```typescript
import matter from 'gray-matter';
import * as vscode from 'vscode';

class Writer {
  async updateField(storyId: string, field: string, value: any): Promise<void> {
    const story = this.store.getStory(storyId);
    if (!story) throw new Error(`Story ${storyId} not found`);

    const filePath = story.filePath;
    const content = await vscode.workspace.fs.readFile(vscode.Uri.file(filePath));
    const fileContent = Buffer.from(content).toString('utf8');

    const parsed = matter(fileContent);

    // Update field
    parsed.data[field] = value;

    // Auto-update timestamp
    parsed.data.updated = this.today();

    // Stringify back (preserves content)
    const newContent = matter.stringify(parsed.content, parsed.data);

    await vscode.workspace.fs.writeFile(
      vscode.Uri.file(filePath),
      Buffer.from(newContent, 'utf8')
    );
  }

  private today(): string {
    return new Date().toISOString().split('T')[0];
  }
}
```

## Conflict Detection (Enhanced)

```typescript
class Writer {
  private fileHashes: Map<string, string> = new Map();

  async updateFieldSafe(storyId: string, field: string, value: any): Promise<void> {
    const story = this.store.getStory(storyId);
    const filePath = story.filePath;

    // Read current content
    const content = await this.readFile(filePath);
    const currentHash = this.hash(content);

    // Check for conflict
    const lastKnownHash = this.fileHashes.get(filePath);
    if (lastKnownHash && lastKnownHash !== currentHash) {
      throw new ConflictError(`File ${filePath} was modified externally`);
    }

    // Proceed with update
    const newContent = this.updateFrontmatter(content, field, value);
    await this.writeFile(filePath, newContent);

    // Update hash
    this.fileHashes.set(filePath, this.hash(newContent));
  }
}
```

## Error Handling

| Scenario | Behavior |
|----------|----------|
| File not found | Throw error, notify user |
| Parse error | Throw error, don't corrupt file |
| Conflict detected | Throw ConflictError, let caller handle (reload + retry or manual merge) |
| Write permission denied | Throw error, suggest checking file permissions |
