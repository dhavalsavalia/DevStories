import * as vscode from 'vscode';
import { executeChangeStatus } from './commands/changeStatus';
import { executeCreateEpic } from './commands/createEpic';
import { executeCreateStory } from './commands/createStory';
import { executeCreateStoryMenu } from './commands/createStoryMenu';
import { wrapCommand } from './commands/errorHandler';
import { executeInit } from './commands/init';
import { executePickSprint } from './commands/pickSprint';
import { executeQuickCapture } from './commands/quickCapture';
import { executeSaveAsTemplate } from './commands/saveAsTemplate';
import { applyAutoFilterSprint } from './core/autoFilterSprint';
import { AutoTimestamp } from './core/autoTimestamp';
import { ConfigService } from './core/configService';
import { initializeLogger, disposeLogger } from './core/logger';
import { SprintFilterService } from './core/sprintFilterService';
import { Store } from './core/store';
import { Watcher } from './core/watcher';
import { updateWelcomeContext } from './core/welcomeContext';
import { FrontmatterCompletionProvider } from './providers/frontmatterCompletionProvider';
import { StoryHoverProvider } from './providers/storyHoverProvider';
import { StoryLinkProvider } from './providers/storyLinkProvider';
import { FrontmatterDiagnosticsProvider } from './validation/frontmatterDiagnostics';
import { StatusBarController } from './view/statusBar';
import { StoriesProvider } from './view/storiesProvider';
import { getTreeViewTitle } from './view/storiesProviderUtils';

export async function activate(context: vscode.ExtensionContext) {
	// Initialize logger first
	const logger = initializeLogger();
	logger.info('DevStories is now active!');

	// Initialize Core Components
	const watcher = new Watcher();
	const store = new Store(watcher);
	const configService = new ConfigService();
	const sprintFilterService = new SprintFilterService();
	const storiesProvider = new StoriesProvider(store, context.extensionPath, configService, sprintFilterService);
	const statusBarController = new StatusBarController(store, configService, sprintFilterService);
	const autoTimestamp = new AutoTimestamp();

	// Initialize config service (loads config and starts watching)
	await configService.initialize();

	// Auto-filter to current sprint if configured (DS-153)
	applyAutoFilterSprint(configService.config, sprintFilterService);

	// Register Tree View with createTreeView for dynamic title updates (DS-139)
	const treeView = vscode.window.createTreeView('devstories.views.explorer', {
		treeDataProvider: storiesProvider
	});

	// Update tree view title and context when sprint filter changes
	sprintFilterService.onDidSprintChange(async (sprint) => {
		treeView.title = getTreeViewTitle(sprint);
		// DS-153: Update context for filter icon state
		await vscode.commands.executeCommand('setContext', 'devstories:hasSprintFilter', sprint !== null);
	});

	// Set initial filter context
	await vscode.commands.executeCommand('setContext', 'devstories:hasSprintFilter', sprintFilterService.currentSprint !== null);

	// Register Document Link Provider for [[ID]] links
	const storyLinkProvider = new StoryLinkProvider(store);
	const linkProviderDisposable = vscode.languages.registerDocumentLinkProvider(
		{ language: 'markdown', scheme: 'file' },
		storyLinkProvider
	);

	// Register Hover Provider for [[ID]] preview
	const storyHoverProvider = new StoryHoverProvider(store);
	const hoverProviderDisposable = vscode.languages.registerHoverProvider(
		{ language: 'markdown', scheme: 'file' },
		storyHoverProvider
	);

	// Register Completion Provider for frontmatter fields and [[ID]] links (DS-123, DS-124)
	const frontmatterCompletionProvider = new FrontmatterCompletionProvider(configService, store);
	const completionProviderDisposable = vscode.languages.registerCompletionItemProvider(
		{ language: 'markdown', scheme: 'file' },
		frontmatterCompletionProvider,
		':',  // Trigger for field values
		' ',  // Trigger after space
		'['   // Trigger for [[ID]] links
	);

	// Register Frontmatter Diagnostics Provider (DS-121, DS-122)
	const diagnosticsProvider = new FrontmatterDiagnosticsProvider(configService, store, context.extensionPath);
	const diagnosticsDisposables = diagnosticsProvider.register();

	// Load initial data and wait for completion
	await store.load();

	// Update welcome context based on folder and epic state
	await updateWelcomeContext(store.getEpics().length);
	store.onDidUpdate(async () => {
		await updateWelcomeContext(store.getEpics().length);
	});

	// Register Commands with error handling
	const initCommand = vscode.commands.registerCommand('devstories.init',
		wrapCommand('init', async () => {
			const success = await executeInit();
			if (success) {
				// Reload store to pick up new files
				await store.load();
				// Update welcome context (folder now exists)
				await updateWelcomeContext(store.getEpics().length);
			}
		})
	);

	const createEpicCommand = vscode.commands.registerCommand('devstories.createEpic',
		wrapCommand('createEpic', async () => {
			await executeCreateEpic(store);
		})
	);

	const createStoryCommand = vscode.commands.registerCommand('devstories.createStory',
		wrapCommand('createStory', async () => {
			await executeCreateStory(store);
		})
	);

	const quickCaptureCommand = vscode.commands.registerCommand('devstories.quickCapture',
		wrapCommand('quickCapture', async () => {
			await executeQuickCapture(store);
		})
	);

	const saveAsTemplateCommand = vscode.commands.registerCommand('devstories.saveAsTemplate',
		wrapCommand('saveAsTemplate', async (story) => {
			await executeSaveAsTemplate(story);
		})
	);

	const changeStatusCommand = vscode.commands.registerCommand('devstories.changeStatus',
		wrapCommand('changeStatus', async (item) => {
			if (item) {
				// Called from context menu with tree item
				const story = store.getStory(item.id);
				const epic = store.getEpic(item.id);
				const target = story || epic;
				if (target) {
					await executeChangeStatus(store, target, configService);
				}
			}
		})
	);

	const pickSprintCommand = vscode.commands.registerCommand('devstories.pickSprint',
		wrapCommand('pickSprint', async () => {
			await executePickSprint(store, sprintFilterService, configService);
		})
	);

	// DS-153: Clear sprint filter command
	const clearSprintFilterCommand = vscode.commands.registerCommand('devstories.clearSprintFilter',
		wrapCommand('clearSprintFilter', async () => {
			sprintFilterService.setSprint(null);
		})
	);

	const openEpicCommand = vscode.commands.registerCommand('devstories.openEpic',
		wrapCommand('openEpic', async (item) => {
			if (item) {
				const epic = store.getEpic(item.id);
				if (epic?.filePath) {
					await vscode.commands.executeCommand('vscode.open', vscode.Uri.file(epic.filePath));
				}
			}
		})
	);

	const createStoryMenuCommand = vscode.commands.registerCommand('devstories.createStoryMenu',
		wrapCommand('createStoryMenu', async () => {
			await executeCreateStoryMenu();
		})
	);

	context.subscriptions.push(
		watcher,
		configService,
		sprintFilterService,
		autoTimestamp,
		statusBarController,
		treeView,
		linkProviderDisposable,
		hoverProviderDisposable,
		completionProviderDisposable,
		diagnosticsProvider,
		...diagnosticsDisposables,
		initCommand,
		createEpicCommand,
		createStoryCommand,
		quickCaptureCommand,
		saveAsTemplateCommand,
		changeStatusCommand,
		pickSprintCommand,
		clearSprintFilterCommand,
		openEpicCommand,
		createStoryMenuCommand
	);
}

export function deactivate() {
	disposeLogger();
}
